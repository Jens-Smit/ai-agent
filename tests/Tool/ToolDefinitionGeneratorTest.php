<?php\n\ndeclare(strict_types=1);\n\nnamespace App\\Tests\\Tool;\n\nuse App\\Tool\\ToolDefinitionGenerator;\nuse PHPUnit\\Framework\\TestCase;\nuse Symfony\\Contracts\\HttpClient\\HttpClientInterface;\nuse Symfony\\Contracts\\HttpClient\\ResponseInterface;\nuse Psr\\Log\\LoggerInterface;\n\nclass ToolDefinitionGeneratorTest extends TestCase\n{\n    private ToolDefinitionGenerator $toolDefinitionGenerator;\n    private HttpClientInterface $mockHttpClient;\n    private LoggerInterface $mockLogger;\n\n    protected function setUp(): void\n    {\n        $this->mockHttpClient = $this->createMock(HttpClientInterface::class);\n        $this->mockLogger = $this->createMock(LoggerInterface::class);\n        $this->toolDefinitionGenerator = new ToolDefinitionGenerator($this->mockHttpClient, $this->mockLogger);\n    }\n\n    public function testRequestNewToolDevelopmentSuccess(): void\n    {\n        $toolName = 'test_tool';\n        $toolDescription = 'A tool to test functionality.';\n        $expectedPrompt = sprintf(\n            'Develop a new Symfony AI Agent tool named \"%s\" with the following functionality: %s. ' .\n            'Ensure the tool follows all Symfony AI Agent tool conventions, including the #[AsTool] attribute, ' .\n            'typed parameters, comprehensive PHPDoc comments, and appropriate return types. ' .\n            'If the tool requires external dependencies (e.g., HTTP clients, specific services), ' .\n            'ensure they are properly injected via the constructor and configured as Symfony services. ' .\
            'Also, generate a corresponding PHPUnit test file with good coverage for the new tool.',\n            $toolName,\n            $toolDescription\n        );\n\n        $mockResponse = $this->createMock(ResponseInterface::class);\n        $mockResponse->method('getStatusCode')->willReturn(200);\n        $mockResponse->method('toArray')->willReturn(['message' => 'Tool request received']);\n\n        $this->mockHttpClient->expects($this->once())\n            ->method('request')\n            ->with(\n                'POST',\n                'http://localhost/api/devAgent',\n                [\n                    'json' => [\n                        'prompt' => $expectedPrompt,\n                    ],\n                ]\n            )\n            ->willReturn($mockResponse);\n\n        $this->mockLogger->expects($this->once())\n            ->method('info')\n            ->with(sprintf('Tool development request for \"%s\" sent successfully.', $toolName));\n\n        $result = $this->toolDefinitionGenerator->requestNewToolDevelopment($toolName, $toolDescription);\n\n        $this->assertStringContainsString('Tool development request for \"test_tool\" has been successfully sent', $result);\n        $this->assertStringContainsString('Tool request received', $result);\n    }\n\n    public function testRequestNewToolDevelopmentFailure(): void\n    {\n        $toolName = 'failing_tool';\n        $toolDescription = 'A tool that will fail.';\n\n        $mockResponse = $this->createMock(ResponseInterface::class);\n        $mockResponse->method('getStatusCode')->willReturn(500);\n        $mockResponse->method('toArray')->willReturn(['error' => 'Internal Server Error']);\n\n        $this->mockHttpClient->expects($this->once())\n            ->method('request')\n            ->willReturn($mockResponse);\n\n        $this->mockLogger->expects($this->once())\n            ->method('error')\n            ->with(\n                $this->stringContains('Failed to send tool development request for \"failing_tool\". Status: 500, Message:')\n            );\n\n        $result = $this->toolDefinitionGenerator->requestNewToolDevelopment($toolName, $toolDescription);\n\n        $this->assertStringContainsString('Failed to send tool development request for \"failing_tool\". The development agent responded with an error (Status: 500).', $result);\n        $this->assertStringContainsString('Internal Server Error', $result);\n    }\n\n    public function testRequestNewToolDevelopmentException(): void\n    {\n        $toolName = 'exception_tool';\n        $toolDescription = 'A tool that causes an exception.';\n\n        $this->mockHttpClient->expects($this->once())\n            ->method('request')\n            ->willThrowException(new \\RuntimeException('Network error'));\n\n        $this->mockLogger->expects($this->once())\n            ->method('error')\n            ->with(\n                $this->stringContains('An error occurred while sending tool development request for \"exception_tool\": Network error')\n            );\n\n        $result = $this->toolDefinitionGenerator->requestNewToolDevelopment($toolName, $toolDescription);\n\n        $this->assertStringContainsString('An unexpected error occurred while requesting tool development for \"exception_tool\": Network error', $result);\n    }\n}\n