# Diese Datei ist der Einstiegspunkt für deine Service-Konfiguration
# Dateien im packages/ Unterverzeichnis konfigurieren deine Abhängigkeiten

parameters:
    app.upload_directory: '%kernel.project_dir%/public/uploads'
    app.api_url: 'https://127.0.0.1:8000'
    chroma.base_url: 'https://localhost:8000'
    google_client_id: '%env(GOOGLE_CLIENT_ID)%'
    google_client_secret: '%env(GOOGLE_CLIENT_SECRET)%'
    google_redirect_uri: '%env(GOOGLE_REDIRECT_URI)%'

services:
    # Standardkonfiguration für Services in dieser Datei
    _defaults:
        autowire: true
        autoconfigure: true
        bind:
            $appEnv: '%kernel.environment%'
    
    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Entity/'
            - '../src/Kernel.php'
            - '../tests/'

    App\Controller\:
        resource: '../src/Controller'
        tags: ['controller.service_arguments']
    # JWT Authenticator
    App\Security\JwtTokenAuthenticator:
        arguments:
            $jwtManager: '@Lexik\Bundle\JWTAuthenticationBundle\Services\JWTTokenManagerInterface'
            $userProvider: '@security.user.provider.concrete.app_user_provider'
    #MessageHandler
    App\MessageHandler\:
        resource: '../src/MessageHandler'
        tags: ['messenger.message_handler']
    # Messenger Middleware
    App\Messenger\Middleware\CircuitBreakerMiddleware:
        arguments:
            $circuitBreaker: '@App\Service\CircuitBreakerService'
            $logger: '@logger'
        tags:
            - { name: 'monolog.logger', channel: 'messenger' }
    
    App\Messenger\Middleware\AgentStatusMiddleware:
        arguments:
            $statusService: '@App\Service\AgentStatusService'
            $logger: '@logger'
        tags:
            - { name: 'monolog.logger', channel: 'messenger' }
   
        ### Services & Tools ###
        ### Services ###

    # AgentStatusService mit EntityManager
    App\Service\AgentStatusService:
        arguments:
            $em: '@doctrine.orm.entity_manager'
    # PasswordService mit konfigurierbarer Frontend-URL
    App\Service\PasswordService:
        arguments:
            $frontendUrl: '%env(FRONTEND_URL)%'
    # GoogleClientService
    App\Service\GoogleClientService:
        arguments:
            $googleClientId: '%env(GOOGLE_CLIENT_ID)%'
            $googleClientSecret: '%env(GOOGLE_CLIENT_SECRET)%'
            $frontendUrl: '%env(FRONTEND_URL)%'  
    # UserContextService
    App\Service\UserContextService:
        public: true
    # Circuit Breaker Service
    App\Service\CircuitBreakerService:
        arguments:
            $cache: '@cache.app'
            $logger: '@logger'
            $failureThreshold: 25       # Anzahl Fehler bevor Circuit öffnet
            $timeout: 60               # Sekunden bis Half-Open-Versuch
            $successThreshold: 2       # Erfolge zum Schließen im Half-Open
        tags:
            - { name: 'monolog.logger', channel: 'circuit_breaker' }

    # AiAgentService mit Circuit Breaker
    App\Service\AiAgentService:
        arguments:
            $agent: '@ai.agent.file_generator'
            $logger: '@logger'
            $agentStatusService: '@App\Service\AgentStatusService'
            $deployTool: '@App\Tool\DeployGeneratedCodeTool'
            $bus: '@messenger.default_bus'
            $conn: '@doctrine.dbal.default_connection'
            $circuitBreaker: '@App\Service\CircuitBreakerService'
        tags:
            - { name: 'monolog.logger', channel: 'ai_agent' }
    # FrontendAgentService mit Circuit Breaker
    App\Service\FrontendAgentService:
        arguments:
            $agent: '@ai.agent.frontend_generator'
            $logger: '@logger'
            $agentStatusService: '@App\Service\AgentStatusService'
            $deployTool: '@App\Tool\DeployGeneratedCodeTool'
            $bus: '@messenger.default_bus'
            $conn: '@doctrine.dbal.default_connection'
            $circuitBreaker: '@App\Service\CircuitBreakerService'
        tags:
            - { name: 'monolog.logger', channel: 'ai_agent' }
 # UserKnowledgeService
    App\Service\UserKnowledgeService:
        arguments:
            $em: '@doctrine.orm.entity_manager'
            $knowledgeRepo: '@App\Repository\UserKnowledgeDocumentRepository'
            $platform: '@ai.platform.gemini'
            $logger: '@logger'

    # UserDocumentService
    App\Service\UserDocumentService:
        arguments:
            $em: '@doctrine.orm.entity_manager'
            $documentRepo: '@App\Repository\UserDocumentRepository'
            $logger: '@logger'
            $uploadDirectory: '%kernel.project_dir%/var/user_uploads'


     
            ### Tools ###

    # CodeSaverTool
    App\Tool\CodeSaverTool:
        arguments:
            $logger: '@logger'
        tags:
            - { name: 'ai.tool' }
    
    # AnalyzeCodeTool
    App\Tool\AnalyzeCodeTool:
        autowire: true
        autoconfigure: true
        public: false  
    # ReceiveMailTool 
    App\Tool\ReceiveMailTool:
        arguments:
            $logger: '@logger'
            $entityManager: '@doctrine.orm.entity_manager'
        tags: ['ai.tool']
    # SendMailTool
    App\Tool\SendMailTool:
        arguments:
            $logger: '@logger'
            $entityManager: '@doctrine.orm.entity_manager'
            $mailer: '@mailer' # Der Standard-Mailer wird hier übergeben, aber im Tool überschrieben
        tags: ['ai.tool']
 
    # SandboxExecutorTool
    App\Tool\SandboxExecutorTool:
        arguments:
            # Manuelle Definition der Abhängigkeiten, falls autowire deaktiviert ist
            $kernel: '@kernel'
            $logger: '@logger'
            $statusService: '@App\Service\AgentStatusService'
        tags:
            # WICHTIG: Manuelles Tagging für das AI-Bundle
            - { name: 'symfony.ai.tool', alias: 'run_code_in_sandbox' }
    # WebScraperTool
    App\Tool\WebScraperTool:
        arguments:
            $httpClient: '@http_client'
            $logger: '@logger'
        tags: ['ai.tool']
    # ApiClientTool
    App\Tool\ApiClientTool:
        arguments:
            $httpClient: '@http_client'
            $logger: '@logger'
        tags: ['ai.tool'] 
    # ToolRequestor
    App\Tool\ToolRequestor:
        arguments:
            $logger: '@Psr\Log\LoggerInterface'
            $githubToken: '%env(GITHUB_ACCESS_TOKEN)%'
            # PASSEN SIE DIESE ZEILE AN: Ersetzen Sie den Wert durch Ihr tatsächliches GitHub-Repository (z.B. 'Krostar/AI-Agent-Tools')
            $githubRepo: '%env(DEV_AGENT_GITHUB_REPO)%'
            $httpClient: '@Symfony\Contracts\HttpClient\HttpClientInterface'
   
    App\Tool\PdfGenerator:
        arguments:
            $logger: '@logger'
            $projectRootDir: '%kernel.project_dir%'
        tags: ['ai.tool']
    
    # Updated KnowledgeIndexerTool mit MySQL Support
    App\Tool\KnowledgeIndexerTool:
        arguments:
            $platform: '@ai.platform.gemini'
            $em: '@doctrine.orm.entity_manager'
            $knowledgeRepo: '@App\Repository\KnowledgeDocumentRepository'
            $logger: '@logger'
        tags: ['ai.tool']

    # NEW: MySQL Knowledge Search Tool
    App\Tool\MySQLKnowledgeSearchTool:
        arguments:
            $platform: '@ai.platform.gemini'
            $knowledgeRepo: '@App\Repository\KnowledgeDocumentRepository'
            $logger: '@logger'
        tags:
            - { name: 'ai.tool' }
    # GoogleCalendarCreateEventTool        
    App\Tool\GoogleCalendarCreateEventTool:
        arguments:
            $logger: '@logger'
            $userRepository: '@App\Repository\UserRepository'
            $googleClientService: '@App\Service\GoogleClientService'
        tags: ['ai.tool']        
    # JobSearchTool
    App\Tool\JobSearchTool:
        arguments:
            $httpClient: '@http_client'
            $logger: '@logger'
        tags: ['ai.tool']
    # UserKnowledgeSearchTool
    App\Tool\UserKnowledgeSearchTool:
        arguments:
            $platform: '@ai.platform.gemini'
            $knowledgeRepo: '@App\Repository\UserKnowledgeDocumentRepository'
            $userRepository: '@App\Repository\UserRepository'
            $logger: '@logger'
        tags: ['ai.tool']

    # AddUserKnowledgeTool
    App\Tool\AddUserKnowledgeTool:
        arguments:
            $knowledgeService: '@App\Service\UserKnowledgeService'
            $userRepository: '@App\Repository\UserRepository'
            $logger: '@logger'
        tags: ['ai.tool']

    # UserDocumentTool
    App\Tool\UserDocumentTool:
        arguments:
            $documentService: '@App\Service\UserDocumentService'
            $documentRepo: '@App\Repository\UserDocumentRepository'
            $userRepository: '@App\Repository\UserRepository'
            $logger: '@logger'
        tags: ['ai.tool']
    # GitHubIssueManagerTool
    App\Tool\GitHubIssueManagerTool:
        arguments:
            $httpClient: '@http_client'
            $logger: '@logger'
            $githubAccessToken: '%env(GITHUB_ACCESS_TOKEN)%'
            $githubRepo: '%env(DEV_AGENT_GITHUB_REPO)%'
        tags: ['ai.tool']
            
        